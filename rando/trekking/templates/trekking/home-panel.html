{% load i18n static leaflet_tags %}

<script type="text/javascript">
    function mainmapInit(map, bounds) {
        map.fitBounds([
            [{{ settings.map.extent.1 }}, {{ settings.map.extent.0 }}],
            [{{ settings.map.extent.3 }}, {{ settings.map.extent.2 }}]
        ]);

        // Move controls to the right
        map.zoomControl.setPosition('topright');
        map.addControl(new L.Control.Scale({imperial: false, position: 'bottomright'}));

        var style = {'color': '#F89406', 'weight': 5, 'opacity': 0.8},
            treksLayer = new TrekLayer(treks, {highlight: true, style: style});
        treksLayer.registerStyle('normal', 10, style)
                  .registerStyle('highlight', 30, {'color': 'yellow', 'weight': 8, 'opacity': 1});
        treksLayer.addTo(map);


        // Filter map on filter
        $(window.trekFilter).on("filterchange", function(e, visible) {
            treksLayer.updateFromPks(visible);
        });

        // Filter list by map bounds
        map.on('moveend', function (e) {
          var getpk = function (l) {
            return l.properties.pk;
          };
          if (!$(map._container).is(':visible')) {
              // If map is hidden, consider all visible :)
              window.trekFilter.setVisible($.map(treks.features, getpk));
          }
          else {
              var visible = treksLayer.search(map.getBounds());
              window.trekFilter.setVisible($.map(visible, getpk));
          }
        });

        // Popup on click on trek 
        var popup = null;
        treksLayer.on('click', function (e) {
            var layer = e.layer;
            if (popup) {
                popup._close();
            }
            var html = '<h3>%NAME%</h3>' + 
                       '<p>%DESCRIPTION%</p>' + 
                       '<img src="{% static "img/trek.jpg" %}" width="110" height="110" />'+ 
                       '<p class="popupdetail"><a href="#">{% trans "More info..." %}</a></p>';
            html = html.replace('%NAME%', layer.properties.name);
            html = html.replace('%DESCRIPTION%', layer.properties.description || "{% trans "No description..." %}");
            popup = L.popup().setLatLng(e.latlng)
                 .setContent(html)
                 .openOn(map);
            // Make sure clic on details will open as pjax
            $('.popupdetail a', popup._container).click(function () {
                $('#trek-'+ e.layer.properties.pk +'.result a.pjax').click();
            });
            
        });

        // Go to detail page on double-click
        treksLayer.on('dblclick', function (e) {
            $('#trek-'+ e.layer.properties.pk +'.result a.pjax').click();
        });
        $('.side-bar .result').on('dblclick', function (e) {
            $('#trek-'+ $(this).data('id') +'.result a.pjax').click();
        });


        // Highlight map on hover in sidebar results
        $('.side-bar .result').hover(function () {
            treksLayer.highlight($(this).data('id'), true);
          },
          function () {
            treksLayer.highlight($(this).data('id'), false);
          }
        );
        // Click on side-bar
        $('.side-bar .result').on('click', function (e) {
            var trekOnMap = treksLayer.getLayer($(this).data('id'));
            if (trekOnMap) {
                var coords = trekOnMap.getLatLngs(),
                    middlepoint = coords[coords.length/2];
                trekOnMap.fire('click', {
                  latlng: middlepoint,
                });
            }
            else {
              console.warn("Trek not on map: " + $(this).data('id'));
            }
        });

        // Zoom trek button
        $('.search-rando').on('click', function (e) {
          var layer = treksLayer.getLayer($(this).data('pk'));
          if (layer) {
            map.fitBounds(layer.getBounds());
          }
        });

        // Vice versa, highlight result
        treksLayer.on('mouseover', function (e) {
          $('#trek-'+ e.layer.properties.pk +'.result').addClass('active');
        });
        treksLayer.on('mouseout', function (e) {
          $('#trek-'+ e.layer.properties.pk +'.result').removeClass('active');
        });
    }
</script>

{% include "trekking/navigation_fragment.html" %}




<div id="show-side-bar" style="display: none"></div>
<div class="side-bar" id="side-bar">

  <div id="text-search" class="search1">
    <div class="span4">
      <div class="control-group">
        <div class="controls">
          <div class="input-prepend"> <span class="add-on"> <i class="icon-search"></i> </span>
            <input type="search" class="span3" placeholder="{% trans "Name, Valley, ..."%}" data-filter="search" id="search"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="result-backpack-tabs" class="tabbable"> 
    <ul class="nav nav-tabs">
      <li id="tab-results" class="active">
        <a href="#results-pane">
            <span class="badge badge-warning">{{ treks|length }}</span> {% trans "Results" %}</a>
      </li>
      <li id="tab-backpack">
        <a href="#backpack-pane">
            <span class="badge">0</span>{% trans "Backpack" %}</a>
      </li>
      <li id="tab-showhidepanel">
        <a id="hide-side-bar" href="#" data-toggle="tab">.</a>
      </li>
    </ul>

    <div id="result-backpack-content" class="tab-content">
      <div class="tab-pane active" id="results-pane">
        {% for trek in treks %}
            {% include "trekking/trek_result_fragment.html" with show="True" %}
        {% endfor %}
      </div>

      <div class="tab-pane" id="backpack-pane">
        {% for trek in treks %}
            {% include "trekking/trek_result_fragment.html" with show="False" %}
        {% endfor %}
      </div>
    </div>
  </div>

</div>
<!-- sidebar -->



{% leaflet_map 'mainmap' fitextent=False creatediv=False %}

<div id="mainmap-tag" style="display: none"><!-- custom tag to detect loaded page--></div>