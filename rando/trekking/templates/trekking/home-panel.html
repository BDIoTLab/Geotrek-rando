{% load i18n static leaflet_tags trekking %}

{% include "trekking/navigation_fragment.html" %}

<div id="search-bar">
  <p class="title">{% trans "Filters" %}</p>

  <div id="basic-filters">
    <div class="stage">
      <label>{% trans "Difficulty" %}</label>
      <div class="slider-wrap">
        <div id="stage" data-filter="stage"></div>
      </div>
      <div class="slider-value first">{% trans "Easy" %}</div>
      <div class="slider-value">{% trans "Medium" %}</div>
      <div class="slider-value last">{% trans "Hard" %}</div>
    </div>
    <div class="time">
      <label>{% trans "Duration" %}</label>
      <div class="slider-wrap">
        <div id="time" data-filter="time"></div>
      </div>
      <div class="slider-value first">{% trans "Short" %}</div>
      <div class="slider-value">1/2</div>
      <div class="slider-value">{% trans "day" %}</div>
      <div class="slider-value">{% trans "2 days" %}</div>
      <div class="slider-value last">&gt;{% trans "2 days" %}</div>
    </div>
    <div class="den">
      <label>{% trans "Climb" %}</label>
      <div class="slider-wrap">
        <div id="den" data-filter="den"></div>
      </div>
      <div class="slider-value first">&lt; 200m</div>
      <div class="slider-value">200-700m</div>
      <div class="slider-value">700-1000m</div>
      <div class="slider-value last">&gt;1000m</div>
    </div>

    <div class="theme">
      <label>{% trans "Thematic" %}</label>
      {% for theme in themes %}
        <div class="filter" data-filter="theme" data-id="{{ theme.id }}" id="theme-{{ theme.id }}">
          {{ theme|pictogram }}
          <p>{{ theme.label }}</p>
      </div>
      {% endfor %}
    </div>

    <div id="filters-actions">
      <a id="clear-filters" href="#"></a> 
      <a id="show-filters" href="#" class="show-hide-filters"></a> 
      <a id="hide-filters" href="#" class="show-hide-filters" style="display: none"></a>
    </div>

  </div>

  <div id="advanced-filters" style="display: none">

    <div class="filter-bloc usage">
      <select id="usage" tabindex="2" multiple="" data-filter="usage" data-placeholder="{% trans "Usages" %}">
      {% for usage in usages %}
        <option data-filter="usage" data-id="{{ usage.id }}" value="{{ usage.id }}">{{ usage.label }}</option>
      {% endfor %}
      </select>
    </div>

    <div class="filter-bloc vallee">
      <select id="district" tabindex="2" multiple="" data-filter="district" data-placeholder="{% trans "Valleys" %}">
      {% for district in districts %}
        <option data-filter="district" data-id="{{ district.id }}" value="{{ district.id }}">{{ district.name }}</option>
      {% endfor %}
      </select>
    </div>

    <div class="filter-bloc cities">
      <select id="city" tabindex="2" multiple="" data-filter="city" data-placeholder="{% trans "Cities" %}">
      {% for city in cities %}
        <option data-filter="city" data-id="{{ city.code }}" value="{{ city.code|safe }}">{{ city.name }}</option>
      {% endfor %}
      </select>
    </div>

    <div class="filter-bloc route">
      <select id="route" tabindex="2" multiple="" data-filter="route"  data-placeholder="{% trans "Route" %}">
      {% for route in routes %}
        <option data-filter="route" data-id="{{ route.id }}" value="{{ route.id|safe }}">{{ route.label }}</option>
      {% endfor %}
      </select>
    </div>

  </div>
  <!--  advanced-filters-->

</div>
<!--  search-bar-->

<div class="row-fluid">
<div class="search-tabs side-bar span4" id="side-bar">

  <div id="toggle-side-bar"></div>

  <div id="text-search" class="search1">
    <div class="span4">
      <div class="control-group">
        <div class="controls">
          <div class="input-prepend"> <span class="add-on"> <i class="icon-search"></i> </span>
            <input type="search" class="span3" placeholder="{% trans "Name, Valley, ..."%}" data-filter="search" id="search"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="result-backpack-tabs" class="tabbable"> 
    <ul class="nav nav-tabs">
      <li id="tab-results" class="active">
        <a href="#results">
            <span class="badge badge-warning">{{ treks|length }}</span> {% trans "Results" %}</a>
      </li>
      <li id="tab-backpack">
        <a href="#backpack">
            <span class="badge">0</span>{% trans "Backpack" %}</a>
      </li>
    </ul>

    <div id="result-backpack-content" class="tab-content">
      <div class="tab-pane active" id="results-pane">
        <p id="noresult" style="display:none" class="tab-content-empty">{% trans "No result" %}</p>
        {% for trek in treks %}
            {% include "trekking/trek_result_fragment.html" with show="True" backpack="False" %}
        {% endfor %}
      </div>

      <div class="tab-pane" id="backpack-pane">
        <p id="backpackempty" style="display:none" class="tab-content-empty">{% trans "Empty" %}</p>
        {% for trek in treks %}
            {% include "trekking/trek_result_fragment.html" with show="False" backpack="True" %}
        {% endfor %}
      </div>
    </div>
  </div>

</div>
</div>
<!-- sidebar -->

{% leaflet_map 'mainmap' fitextent=False creatediv=False %}

<div id="mainmap-tag" style="display: none"><!-- custom tag to detect loaded page--></div>

<script type="text/javascript">
    function mainmapInit(map, bounds) {
        var style = {'color': '#F89406', 'weight': 5, 'opacity': 0.8};
        window.treksLayer = new TrekLayer(treks, {highlight: true, style: style});
        treksLayer.registerStyle('normal', 10, style)
                  .registerStyle('highlight', 30, {'color': 'yellow', 'weight': 8, 'opacity': 1});
        treksLayer.addTo(map);

        if (!map.restoreView()) {
            map.fitFakeBounds(treksLayer.getBounds());
        }

        // Move controls to the right
        map.zoomControl.setPosition('topright');
        map.addControl(new L.Control.Scale({imperial: false, position: 'bottomright'}));

        // Filter map on filter
        $(window.trekFilter).on("filterchange", function(e, visible) {
            treksLayer.updateFromPks(visible);
        });

        // Filter list by map bounds
        map.on('moveend', function (e) {
          $('#side-bar .result').removeClass('outbounds');
          if (!$(map._container).is(':visible')) {
            // If map is hidden, consider all visible :)
            return;
          }
          var visible = treksLayer.search(map.getFakeBounds())
            , visiblepks = $.map(visible, function (l) { return l.properties.pk});
          $.each(treks.features, function (i, l) {
              var pk = l.properties.pk;
              if ($.inArray(pk, visiblepks) == -1) {
                $("#side-bar .result[data-id='" + pk + "']").addClass('outbounds');
              }
          });
        });

        // Go to detail page on double-click
        treksLayer.on('dblclick', function (e) {
            // Track event
            _gaq.push(['_trackEvent', 'Map', 'Doubleclick', e.layer.properties.name]);
            // Simulate click on link
            $('#trek-'+ e.layer.properties.pk +'.result a.pjax').click();
        });

        // Popup on click on trek 
        var popup = null;
        treksLayer.on('click', function (e) {
            var layer = e.layer;
            if (popup) {
                popup._close();
            }
            var html = '<h3>%NAME%</h3>' + 
                       '<p>%DESCRIPTION%</p>' + 
                       '<img src="%THUMBNAIL%" %}"/>'+ 
                       '<p class="popupdetail"><a href="#"<a href="#">{% trans "More info..." %}</a></p>';
            html = html.replace('%NAME%', layer.properties.name);
            // This is tricky : use img url of trek in result list :)
            html = html.replace('%THUMBNAIL%', $('#trek-'+ e.layer.properties.pk +'.result img').attr('src'));
            html = html.replace('%DESCRIPTION%', layer.properties.description || "{% trans "No description..." %}");
            popup = L.popup().setLatLng(e.latlng)
                 .setContent(html)
                 .openOn(map);
            // Make sure clic on details will open as pjax
            $('.popupdetail a', popup._container).click(function () {
                // Track event
                _gaq.push(['_trackEvent', 'Map', 'Popup', e.layer.properties.name]);
                // Navigate to details
                $('#trek-'+ e.layer.properties.pk +'.result a.pjax').click();
            });
            
        });

        // Highlight result on mouseover
        treksLayer.on('mouseover', function (e) {
          $('#trek-'+ e.layer.properties.pk +'.result').addClass('active');
        });
        treksLayer.on('mouseout', function (e) {
          $('#trek-'+ e.layer.properties.pk +'.result').removeClass('active');
        });
    }
</script>