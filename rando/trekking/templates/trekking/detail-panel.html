{% load static i18n leaflet_tags trekking %}

{% include "trekking/navigation_fragment.html" %}

{% if pjax %}
  <title>{{ object.title }}</title>
{% endif %}

<div class="detail-content">
  <div class="row-fluid" id="detail-content-top">
    {% include "trekking/fake_searchtabs_fragment.html" %}

    <div class="span4">
      <h2>{{ object.properties.name }}</h2>
    </div>
    <div class="span4">
      <div id="toolbox">
        <a class="btn" id="share" href=""><img src="{% static "img/partager.png" %}"> {% trans "Share" %}</a>
        <a class="btn" id="print" href=""><img src="{% static "img/imprimante.png" %}"> {% trans "Print" %}</a>
        <a class="btn add-sac" href="#" data-pk="{{ trek.properties.pk }}"><img src="{% static "img/sacplus.png" %}"> {% trans "Add to backpack" %}</a>
      </div>
    </div>
  </div>

  <div id="detail-container-content" class="row-fluid">
    <div class="span3">
      <p class="teaser">{{ object.properties.description_teaser|default:"No teaser"|safe }}</p>
      <p>{{ object.properties.description|default:"No description"|safe }}</p>

      <div id="trek-pictures" class="carousel slide">
        <div class="carousel-inner">
          {% for picture in object.properties.pictures %}
          <div class="item {% if forloop.first %} active{% endif %}">
            <img src="{{ picture.url }}" alt="{{ picture.title }}" />
            <div class="carousel-caption">
              <p>{{ picture.legend }}</p>
            </div>
          </div>
          {% empty%}
          <div class="item active">
            <img src="{% static "img/default-preview.jpg" %}"/>
          </div>
          {% endfor %}
        </div>
        <a class="carousel-control left" href="#trek-pictures" data-slide="prev">&lsaquo;</a>
        <a class="carousel-control right" href="#trek-pictures" data-slide="next">&rsaquo;</a>
      </div><!-- /.carousel -->

      <p>{{ object.properties.ambiance|default:"No ambiance"|safe }}</p>
    </div>

    <div class="span2">
      <div id="trek-identity" class="well">
        <h4 id="departure-arrival">{{ object.properties.departure }} &rarr; {{ object.properties.arrival }}</h4>

        {% if object.properties.route %}
        <p>{% trans "Route" %} : <span class="value">{{ object.properties.route.label }}</span></p>
        {% endif %}

        <p>{% trans "Valleys" %} : <span class="value">{% for district in object.properties.districts %}{{ district.name }}, {% endfor %}</span></p>
        <p>{% trans "Difficulty" %} : <span class="value">{{ object.properties.difficulty.label }}</span></p>
        <p>{% trans "Ascent" %} : <span class="value">{{ object.properties.ascent }}m</span></p>
        <p>{% trans "Descent" %} : <span class="value">{{ object.properties.descent }}m</span></p>
        <p>{% trans "Duration" %} : <span class="value">{{ object.properties.duration|default:0 }}H</span></p>
        <p>{% trans "Min elevation" %} : <span class="value">{{ object.properties.min_elevation }}m</span></p>
        <p>{% trans "Max elevation" %} : <span class="value">{{ object.properties.max_elevation }}m</span></p>
      </div>

      {% for usage in object.properties.usages %}
        {% if forloop.first %}<div id="usages"><h3>{% trans "Usages" %}</h3><ul>{% endif %}
        <li>{{ usage|pictogram:"big" }} {{ usage.label }}</li>
        {% if forloop.last %}</ul></div>{% endif %}
      {% endfor %}

      {% for theme in object.properties.themes %}
        {% if forloop.first %}<div id="themes"><h3>{% trans "Themes" %}</h3><ul>{% endif %}
        <li>{{ theme|pictogram:"big" }} {{ theme.label }}</li>
        {% if forloop.last %}</ul></div>{% endif %}
      {% endfor %}

      {% for network in object.properties.networks %}
        {% if forloop.first %}<div id="networks"><h3>{% trans "Networks" %}</h3><ul>{% endif %}
        <li>{{ network.name }}</li>
        {% if forloop.last %}</ul></div>{% endif %}
      {% endfor %}
      
      <div id="trek-advice">
        {% if object.properties.advice or object.properties.public_transport or object.properties.disabled_infrastructure %}
          <h3>{% trans "Advice" %}</h3>
        {% endif %}
        {% if object.properties.advice %}<p>{{ object.properties.advice|safe }}</p>{% endif %}
        {% if object.properties.public_transport %}<p>{{ object.properties.public_transport|safe }}</p>{% endif %}
        {% if object.properties.disabled_infrastructure %}<p>{{ object.properties.disabled_infrastructure|safe }}</p>{% endif %}
      </div>

      <div id="trek-links">
        <h3>{% trans "See also" %}</h3>

        {% regroup object.properties.web_links by category as weblinks %}

        <ul>
        {% for weblink in weblinks %}
            <li>{{ weblink.grouper|pictogram:"small" }} {{ weblink.grouper.label }}
            {% for item in weblink.list %}
              {% if forloop.first and weblink.list.count > 1 %}<ul>{% endif %}
              {% if weblink.list.count > 1 %}<li>{% endif %}
              <a target="_blank" href="{{ item.url }}">{{ item.name }}</a>
              {% if weblink.list.count > 1 %}</li>{% endif %}
              {% if forloop.last and weblink.list.count > 1 %}</ul>{% endif %}
            {% endfor %}
            </li>
        {% endfor %}
        </ul>

        {% for relationship in object.properties.relationships_departure %}
          {% if forloop.first %}
            <h4>{% trans "Sharing departure" %}</h4>
            <ul>
          {% endif %}
          <li><a href="{% url trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
          {% if forloop.last %}</ul>{% endif %}
        {% endfor %}

        {% for relationship in object.properties.relationships_edge %}
          {% if forloop.first %}
            <h4>{% trans "Sharing paths" %}</h4>
            <ul>
          {% endif %}
          <li><a href="{% url trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
          {% if forloop.last %}</ul>{% endif %}
        {% endfor %}

        {% for relationship in object.properties.relationships_circuit %}
          {% if forloop.first %}
            <h4>{% trans "Sharing circuit" %}</h4>
            <ul>
          {% endif %}
          <li><a href="{% url trekking:detail relationship.trek.slug %}">{{ relationship.trek.name }}</a></li>
          {% if forloop.last %}</ul>{% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="span{% if object.pois.all %}4{% else %}7{% endif %}">
      {% if object.properties.is_park_centered %}
        <div class="alert alert-info">
            <p><strong>{% trans "This trek is within park center" %}</strong>, <a class="pjax" href="{% url flatpages:redirect "1" %}">{% trans "please read access rules." %}</a></p>
        </div>
      {% endif %}

      {% leaflet_map 'detailmap' fitextent=False %}

      <div id="altitudegraph">
          <h4>{% trans "Altitude profile" %}</h4>
          <p class="axislabel">{% trans "Altitude (m)" %}</p>
          <span id="profilealtitude"></span> <span class="axislabel">{% trans "Distance (m)" %}</span>
          <p id="mouseoverprofil" class="axislabel" >&nbsp;</p>
      </div>

      <p class="download"><a href="{% url trekking:fileserve object.gpx_url %}">{% trans "Download GPX" %}</a></p>
      <p class="download"><a href="{% url trekking:fileserve object.kml_url %}">{% trans "Download for Google Earth" %}</a></p>
    </div>

    <div class="{% if object.pois.all %}span3{% endif %}">
      <div class="accordion" id="pois-accordion">
        {% for poi in object.pois.all %}
        <div class="accordion-group">
          <div class="accordion-heading">
            <a class="accordion-toggle acc-open" id="poi-item-{{ poi.properties.pk}}" data-toggle="collapse" data-parent="#pois-accordion" data-id="{{ poi.properties.pk }}" href="#collapse-poi-{{  poi.properties.pk }}">
              {{ poi.properties.type|pictogram }}
              {{ poi.properties.name }}
            </a>
          </div>
          <div id="collapse-poi-{{  poi.properties.pk }}" class="accordion-body collapse" style="height: 0px; ">
            <div class="accordion-inner"><p>{{ poi.properties.description|safe }}</p></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
</div>


<script type="text/javascript">
    var poisMarkers = {};

    function detailmapInit(map, bounds) {

        var poisMarkers = function(featureData, latlng) {
            var img = '<img src="%SRC%" title="%TITLE%">';
            img = img.replace('%SRC%', featureData.properties.type.pictogram);
            img = img.replace('%TITLE%', featureData.properties.type.label);
            
            var poicon = new L.DivIcon({className: 'poi-marker-icon',
                                        iconAnchor: [12, 12],
                                        html: img}),
                marker = L.marker(latlng, {icon: poicon});
            marker.on('click', function (e) {
                $('#poi-item-' + featureData.properties.pk).click();
            });
            window.poisMarkers[featureData.properties.pk] = marker;
            return marker;
        };

        $('#pois-accordion').on('open', function (e, accordion) {
            var id = $(accordion).data('id'),
                marker = window.poisMarkers[id];
            $(marker._icon).animate({"margin-top": "-=20px"}, "fast",
                                    function(){
                                        $(this).animate({"margin-top": "+=20px"}, "fast");
                                    });
        });

        // Trek
        var trekGeoJSON = {{ trek.geojson|safe }};
        var trekLayer = new L.GeoJSON(trekGeoJSON, {
            style: {color: 'orange', opacity: 1.0, clickable: false},
        });
        trekLayer.addTo(map);
        // Show start and end

        var originlonlat = {{trek.startcoords|safe }}
          , destinationlonlat = {{trek.endcoords|safe }};
        L.marker(L.latLng(originlonlat[1], originlonlat[0]),
                 {clickable: false,
                  icon: new L.Icon.Default({iconUrl: '{% static "img/marker-source.png" %}'})}).addTo(map);
        L.marker(L.latLng(destinationlonlat[1], destinationlonlat[0]),
                 {clickable: false,
                  icon: new L.Icon.Default({iconUrl: '{% static "img/marker-target.png" %}'})}).addTo(map);

        map.fitBounds(trekLayer.getBounds()).zoomOut();

        var poisLayer = new L.GeoJSON({{ poisjson|safe }}, {
            pointToLayer: poisMarkers
        });
        poisLayer.addTo(map);

        var parkingIcon = L.icon({
            iconUrl: '{% static "img/parking.png" %}',
            iconSize: [24, 24],
            iconAnchor: [0, 0],
        });
        var parkingLocation = {{ object.properties.parking_location|default:"null" }};
        if (parkingLocation) {
          L.marker([parkingLocation[1], parkingLocation[0]],
                   {icon: parkingIcon})
           .bindPopup("{{ object.properties.advised_parking }}" || "{% trans "Recommended parking" %}")
           .addTo(map);
        }

        //Load altimetric graph
        altimetricInit();
    }

    function altimetricInit() {
        /* 
         * Load altimetric profile from JSON
         */
        $.getJSON("{% url trekking:fileserve object.altimetric_url %}", function(data) {
            $('#profilealtitude').sparkline(data.profile, {tooltipSuffix: ' m', width: 300, height: 100});
            $('#profilealtitude').bind('sparklineRegionChange', function(ev) {
                var sparkline = ev.sparklines[0],
                    region = sparkline.getCurrentRegionFields();
                    value = region.y;
                $('#mouseoverprofil').text(Math.round(region.x) +" m");
            }).bind('mouseleave', function() {
                $('#mouseoverprofil').text('');
            });
        });
    }
</script>